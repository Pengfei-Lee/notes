# 1 **什么是 MyCat**

**Mycat**是一款开源的分布式关系型**数据库中间件**。它支持分布式SQL查询，兼容MySQL通信协议，以Java生态支持多种后端数据库，通过数据分片提高数据查询处理能力。

- MyCat 是目前最流行的基于 java 语言编写的数据库中间件，是一个实现了 MySQL 协议 的服务器，前端用户可以把它看作是一个数据库代理，用 MySQL 客户端工具和命令行访问，而其后端可以用 MySQL 原生协议与多个 MySQL 服务器通信，也可以用 JDBC 协议与大多数主流数据库服务器通信，其核心功能是分库分表。配合数据库的主从模式还可实现读写分离。MyCat 是基于阿里开源的 Cobar 产品而研发，Cobar 的稳定性、可靠性、优秀的架构和性能以及众多成熟的使用案例使得 MyCat 变得非常的强大。
- MyCat 发展到目前的版本，已经不是一个单纯的 MySQL 代理了，它的后端可以支持MySQL、SQL Server、Oracle、DB2、PostgreSQL 等主流数据库，也支持 MongoDB 这种新型NoSQL 方式的存储，未来还会支持更多类型的存储。而在最终用户看来，无论是那种存储方式，在 MyCat 里，都是一个传统的数据库表，支持标准的 SQL 语句进行数据的操作，这样一来，对前端业务系统来说，可以大幅降低开发难度，提升开发速度。
- 简单来说MyCat就是实现数据库集群的，对海量数据的数据存储的一种解决方案，因为很多数据库不想Oracle一样自带集群的配置，那么在进行海量数据存储的时候就要使用到MyCat进行数据库的管理了。

1. 什么是中间件

   中间件：是一类连接软件组件和应用的计算机软件，以便于软件各部件之间的沟通。

   数据库中间件：连接java应用程序和数据库

   ![image-20210512083835416](https://tva1.sinaimg.cn/large/008i3skNly1gqfcjfre2mj30s004saap.jpg)




# 1 先聊聊数据库

关系型数据库 vs NoSQL数据库

> 原表格：https://www.yuque.com/ccazhw/tuacvk/vttsnv?inner=8YNui

![image-20210513001221092](https://tva1.sinaimg.cn/large/008i3skNly1gqg3izbih8j31e70u0q9y.jpg)

> NoSQL根本性的优势在于在云计算时代，简单、易于大规模分布式扩展，并且读写性能非常高。NoSQL数据库又无法将其替代，NoSQL只能作为传统数据的补充而不能将其替代。
>
> 如果传统数据易于扩展，可切分，就可以避免单机（单库）的性能缺陷，但是由于目前开源或者商用的传统数据库基本不支持大规模自动扩展，所以就需要借助第三方来做处理，那就是本书要讲的数据切分，下面就来分析一下如何进行数据切分。

# 2 数据切分

简单来说，就是指通过某种特定的条件，将我们存放在同一个数据库中的数据分散存放到多个数据库（主机）上面，以达到分散单台设备负载的效果。

数据切分可以分为两种切分模式。

- 数据的垂直切分：按照不同的表来切分到不同的数据库（主机）之上。
- 数据的水平切分：将同一个表中的数据按照某种条件拆分到多台数据库（主机）上面。 

**1.2**   **垂直切分**


一个数据库由很多表的构成，每个表对应着不同的业务，垂直切分是指按照业务将表进行分类，分布到不同的数据库上面，这样也就将数据或者说压力分担到不同的库上面，如下图：


![image](https://cdn.nlark.com/yuque/0/2021/png/658548/1610181911481-55e1e1be-0a69-4a69-a0ed-020df6ffe6d3.png)

系统被切分成了，用户，订单交易，支付几个模块。

一个架构设计较好的应用系统，其总体功能肯定是由很多个功能模块所组成的，而每一个功能模块所需要的数据对应到数据库中就是一个或者多个表。而**在架构设计中，各个功能模块相互之间的交互点越统一越少，系统的耦合度就越低**，**系统各个模块的维护性以及扩展性也就越好。**这样的系统，实现数据的垂直切分也就越容易。

​    但是往往系统之有些表难以做到完全的独立，存在这扩库join的情况，对于这类的表，就需要去做平衡，是数据库让步业务，共用一个数据源，还是分成多个库，业务之间通过接口来做调用。在系统初期，数据量比较少，或者资源有限的情况下，会选择共用数据源，但是当数据发展到了一定的规模，负载很大的情况，就需要必须去做分割。

​    一般来讲业务存在着复杂join的场景是难以切分的，往往业务独立的易于切分。如何切分，切分到何种程度是考验技术架构的一个难题。

下面来分析下垂直切分的优缺点：


**优点：**

- 拆分后业务清晰，拆分规则明确；

- 系统之间整合或扩展容易；

- 数据维护简单。

**缺点：**

- 部分业务表无法join，只能通过接口方式解决，提高了系统复杂度；

- 受每种业务不同的限制存在单库性能瓶颈，不易数据扩展跟性能提高；

- 事务处理复杂。

由于垂直切分是按照业务的分类将表分散到不同的库，所以有些业务表会过于庞大，存在单库读写与存储瓶颈，所以就需要水平拆分来做解决。

**1.3**   **水平切分**

相对于垂直拆分，水平拆分不是将表做分类，而是按照某个字段的某种规则来分散到多个库之中，每个表中包含一部分数据。**简单来说，我们可以将数据的水平切分理解为是按照数据行的切分，就是将表中的某些行切分到一个数据库，而另外的某些行又切分到其他的数据库中**，如图：

![image](https://cdn.nlark.com/yuque/0/2021/png/658548/1610181911968-1d3cc690-f7b6-429b-822e-043489410062.png)

拆分数据就需要定义分片规则。关系型数据库是行列的二维模型，拆分的第一原则是找到拆分维度。比如：从会员的角度来分析，商户订单交易类系统中查询会员某天某月某个订单，那么就需要按照会员结合日期来拆分，不同的数据按照会员ID做分组，这样所有的数据查询join都会在单库内解决；如果从商户的角度来讲，要查询某个商家某天所有的订单数，就需要按照商户ID做拆分；但是如果系统既想按会员拆分，又想按商家数据，则会有一定的困难。如何找到合适的分片规则需要综合考虑衡量。

几种典型的分片规则包括：

·   按照用户ID求模，将数据分散到不同的数据库，具有相同数据用户的数据都被分散到一个库中；

·   按照日期，将不同月甚至日的数据分散到不同的库中；

·   按照某个特定的字段求摸，或者根据特定范围段分散到不同的库中。

如图，切分原则都是根据业务找到适合的切分规则分散到不同的库，下面用用户ID求模举例：

![image](https://cdn.nlark.com/yuque/0/2021/png/658548/1610181912502-5aaf3b8e-b249-4927-b9db-ff432df08ce1.png)

既然数据做了拆分有优点也就优缺点。


**优点：**


·   拆分规则抽象好，join操作基本可以数据库做；

·   不存在单库大数据，高并发的性能瓶颈；

·   应用端改造较少；

·   提高了系统的稳定性跟负载能力。

**缺点：**


·   拆分规则难以抽象；

·   分片事务一致性难以解决；

·   数据多次扩展难度跟维护量极大；

·   跨库join性能较差。

前面讲了垂直切分跟水平切分的不同跟优缺点，会发现每种切分方式都有缺点，但**共同的特点缺点**有：

- 引入分布式事务的问题，数据的一致性

- 跨节点Join的问题；

- 跨节点合并排序分页问题；

- 多数据源管理问题。

`Mycat` 通过数据切分解决传统数据库的缺陷，又有了NoSQL易于扩展的优点。通过中间代理层规避了多数据源的处理问题，对应用完全透明，同时对数据切分后存在的问题，也做了解决方案。

# 3 Mycat 功能

1. 为什么要用Mycat？

   1 Java与数据库紧耦合

   2 高访问量高并发对数据库的压力。

   3 读写请求数据不一致，读多，写少
   
   ![image-20210513004443457](https://tva1.sinaimg.cn/large/008i3skNly1gqg4go77mxj30wp0u0wnp.jpg)

使用mybatis之后的架构图

![image-20210512235402518](https://tva1.sinaimg.cn/large/008i3skNly1gqg2zzhxwwj317e0fa10j.jpg)

![image-20210513004507071](https://tva1.sinaimg.cn/large/008i3skNly1gqg4h2lb2pj317x0u0wl8.jpg)

1. Mycat能干什么？

   - 读写分离，主从备份

     原理：需要搭建主从模式，让主数据库（master）处理事务性增、改、删操作（INSERT、UPDATE、DELETE），而从数据库（slave）处理 SELECT 查询操作。Mycat 配合数据库本身的复制功能，可以解决读写分离的问题。

     主库(Master)数据与备库(Slave)数据完全一致.

     实现数据的多重备份, 保证数据的安全.

     可以在 Master[InnoDB]和 Slave[MyISAM]中使用不同的数据库引擎,实现读写的分离

     主从使用不同的数据库引擎，实现读写分离，提高所有的操作效率。主库选择使用支持事务的innoDB引擎，从库选择不支持事务但是查询效率高的MyISAM引擎。

     > 注意读写分离基于主从备份

     ![image-20210513005426866](https://tva1.sinaimg.cn/large/008i3skNly1gqg4qrlf2dj30yi0kowhq.jpg)

   - 数据分片

     ![image-20210513005512105](https://tva1.sinaimg.cn/large/008i3skNly1gqg4rkczo4j30v80kc79n.jpg)

   - 多数据源整合

     ![image-20210513005524435](https://tva1.sinaimg.cn/large/008i3skNly1gqg4rrookhj30zo0hs0y7.jpg)

# 4 Mycat 原理

Mycat的原理中最重要的一个动词是“拦截”，它拦截了用户发送过来的SQL语句，首先对SQL语句做了一些特定的分析：如分片分析、路由分析、读写分离分析、缓存分析等，然后将此SQL发往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户。

![image](https://cdn.nlark.com/yuque/0/2021/png/658548/1610181913832-22dd54a3-b96a-4837-8fcd-9327704185ca.png)

上述图片里，Orders表被分为三个分片datanode（简称dn)，这三个分片是分布在两台MySQL Server上(DataHost)，即datanode=database@datahost方式，因此你可以用一台到N台服务器来分片，分片规则为（sharding rule)典型的字符串枚举分片规则，一个规则的定义是分片字段（sharding column)+分片函数(rule function)，这里的分片字段为prov而分片函数为字符串枚举方式。

当Mycat收到一个SQL时，会先解析这个SQL，查找涉及到的表，然后看此表的定义，如果有分片规则，则获取到SQL里分片字段的值，并匹配分片函数，得到该SQL对应的分片列表，然后将SQL发往这些分片去执行，最后收集和处理所有分片返回的结果数据，并输出到客户端。以select * from Orders where prov=?语句为例，查到prov=wuhan，按照分片函数，wuhan返回dn1，于是SQL就发给了MySQL1，去取DB1上的查询结果，并返回给用户

# 5 应用场景

Mycat发展到现在，适用的场景已经很丰富，而且不断有新用户给出新的创新性的方案，以下是几个典型的应用场景：

·   单纯的读写分离，此时配置最为简单，支持读写分离，主从切换；

·   分表分库，对于超过1000万的表进行分片，最大支持1000亿的单表分片；

·   多租户应用，每个应用一个库，但应用程序只连接Mycat，从而不改造程序本身，实现多租户化；

·   报表系统，借助于Mycat的分表能力，处理大规模报表的统计；

·   替代Hbase，分析大数据；

·   作为海量数据实时查询的一种简单有效方案，比如100亿条频繁查询的记录需要在3秒内查询出来结果，除了基于主键的查询，还可能存在范围查询或其他属性查询，此时Mycat可能是最简单有效的选择。

# 6 MyCat 优势

- 单一的 MySQL 其数据存储量级和操作量级有限.
- Mycat 可以管理若干 MySQL 数据库,同时实现数据的存储和操作
- Mycat 是 java 编写的中间件. 开源,免费.有非常多的人和组织对 Mycat 实行开发,维护,管理,更新.Mycat 版本提升较快,可以跟随环境发展.如果有问题,可以快速解决.Mycat 有开源和开源社区.且有官方发布的电子书籍.
- Mycat 是阿里原应用 corba 转型而来的.彻底开源的，面向企业应用开发的“大数据库集群”
- 支持事务、ACID、可以替代Mysql的加强版数据库
- 一个可以视为“Mysql”集群的企业级数据库，用来替代昂贵的Oracle集群
- 一个融合内存缓存技术、Nosql技术、HDFS大数据的新型SQL Server结合传统数据库和新型分布式数据仓库的新一代企业级数据库产品
- 一个数据库中间件产品



参考文章：

[MyCat介绍](https://www.cnblogs.com/wenbronk/p/7819224.html)

MyCat官网文档

